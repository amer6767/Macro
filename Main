--[[ 
    AXIORA EPSILON [Tier-3]
    Batch 1 / 4
    Focus: Services, State, IO System [Safe Mode Fix]
]]

--// 1. SAFETY & SERVICES //
-- Safely get environment, supporting fallback if getgenv is broken
local get_env = (typeof(getgenv) == "function" and getgenv) or (function() return _G end)
local cloneref = (typeof(cloneref) == "function" and cloneref) or (function(o) return o end)

-- Initialize Global Table
get_env().Axiora = get_env().Axiora or {}

-- Safety Cleanup (Check if Stop is actually a function before calling)
if typeof(get_env().Axiora.Stop) == "function" then 
    pcall(get_env().Axiora.Stop) 
end

-- Define Service Wrapper
local Services = setmetatable({}, {
    __index = function(_, k)
        -- Uses local cloneref to prevent "nil value" errors inside the loop
        local s = game:GetService(k)
        return cloneref(s)
    end
})

local Players = Services.Players
local Workspace = Services.Workspace
local RunService = Services.RunService
local UserInputService = Services.UserInputService
local VirtualInputManager = Services.VirtualInputManager
local TweenService = Services.TweenService
local HttpService = Services.HttpService
local CoreGui = Services.CoreGui
local GuiService = Services.GuiService
local PathfindingService = Services.PathfindingService
local Lighting = Services.Lighting

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

--// 2. MASTER CONFIGURATION (20 FEATURES) //
-- This table controls the logic for the entire macro.
local Settings = {
    -- [A] MOVEMENT & INPUT
    FluidMotion = true,        -- Smooth walking (no stops)
    CameraSync = true,         -- Record & Replay Camera Angles
    EinsteinOffset = true,     -- Auto-fix GUI Inset for buttons
    SmartPathing = true,       -- Auto-walk around walls (A*)
    ClickHumanizer = true,     -- Randomize click position slightly

    -- [B] VISUALS
    HoloHUD = true,            -- Draw Tron-like path lines
    PredictionBeam = true,     -- Show future path in Blue
    ClickRipples = true,       -- Visual effect on click
    Notifications = true,      -- Custom status alerts
    DarkMode = true,           -- Force Dark Theme

    -- [C] SURVIVAL
    ThermalEco = false,        -- Black screen mode (Save Battery)
    PhoenixRejoin = true,      -- Auto-rejoin on disconnect
    AntiAFK = true,            -- Spoof camera packets
    LootMagnet = false,        -- Micro-nudge to grab tokens
    AutoInteract = false,      -- Auto-fire proximity prompts

    -- [D] ADVANCED
    SmartLag = true,           -- Dynamic Ping Speed adjustment
    InventoryCheck = false,    -- Pause if Backpack full
    ServerHop = false,         -- Change server if stuck
    PanicShake = false,        -- Kill switch gesture
    SoundFX = true,            -- Interface sounds
    
    -- SYSTEM VARIABLES
    Offsets = {X = 0, Y = 0},
    PlaybackSpeed = 1.0,
    Version = "Epsilon 1.0"
}

-- Global State Tracking
local State = {
    Recording = false,
    Replaying = false,
    Paused = false,
    Index = 1,
    StartTime = 0,
    Threads = {},
    Connections = {},
    Visuals = {}
}

--// 3. EINSTEIN MATH HELPER //
local MathUtils = {}

function MathUtils.SerializeVector(v)
    return {X = math.round(v.X*100)/100, Y = math.round(v.Y*100)/100, Z = math.round(v.Z*100)/100}
end

function MathUtils.DeserializeVector(t)
    return Vector3.new(t.X or 0, t.Y or 0, t.Z or 0)
end

function MathUtils.SerializeCFrame(cf)
    -- Reduce precision to save file size
    local components = {cf:GetComponents()}
    for i, v in ipairs(components) do components[i] = math.round(v*1000)/1000 end
    return components
end

function MathUtils.DeserializeCFrame(t)
    if not t or #t < 12 then return CFrame.new() end
    return CFrame.new(table.unpack(t))
end

-- TopBar Logic Fix
function MathUtils.GetTrueInput(pos)
    -- On Replay: Subtract Inset. On Record: We grab RAW.
    local inset = GuiService:GetGuiInset()
    return Vector2.new(pos.X, pos.Y - inset.Y)
end

--// 4. CHRONOS FILE SYSTEM (Deep Serialization) //
local FileSystem = {}
FileSystem.Folder = "AxioraData"
FileSystem.Ext = ".json" -- Using standard JSON for compatibility

if makefolder and not isfolder(FileSystem.Folder) then makefolder(FileSystem.Folder) end

function FileSystem.SaveProfile(name, rawData)
    if not writefile then return false, "No File Access" end
    
    -- Prepare Data Structure (Convert CFrame/Vector3 to Tables)
    local serializableData = {}
    
    for _, action in ipairs(rawData) do
        local node = { Type = action.Type, Time = math.round(action.Time*1000)/1000 }
        
        if action.Type == "Move" then
            node.Pos = MathUtils.SerializeVector(action.Pos)
            if action.Cam then 
                node.Cam = MathUtils.SerializeCFrame(action.Cam)
            end
        elseif action.Type == "Tap" then
            node.XY = {X = action.XY.X, Y = action.XY.Y}
        elseif action.Type == "Wait" then
            node.Dur = action.Dur
        end
        
        table.insert(serializableData, node)
    end
    
    local Profile = {
        Info = { Date = os.date(), Ver = Settings.Version, Actions = #rawData },
        Config = Settings, -- Save your current Toggles
        Data = serializableData
    }
    
    local success, encoded = pcall(function() return HttpService:JSONEncode(Profile) end)
    if success then
        writefile(FileSystem.Folder .. "/" .. name .. FileSystem.Ext, encoded)
        return true
    else
        warn("JSON Encode Fail: " .. tostring(encoded))
        return false
    end
end

function FileSystem.LoadProfile(name)
    local path = FileSystem.Folder .. "/" .. name .. FileSystem.Ext
    if not isfile(path) then return nil end
    
    local raw = readfile(path)
    local decoded = HttpService:JSONDecode(raw)
    
    if not decoded or not decoded.Data then return nil end
    
    -- Restore Config
    if decoded.Config then
        for k,v in pairs(decoded.Config) do
            if Settings[k] ~= nil then Settings[k] = v end
        end
    end
    
    -- Deserialize Data (Table -> Vector3/CFrame)
    local activeData = {}
    for _, node in ipairs(decoded.Data) do
        local action = { Type = node.Type, Time = node.Time }
        if node.Type == "Move" then
            action.Pos = MathUtils.DeserializeVector(node.Pos)
            if node.Cam then action.Cam = MathUtils.DeserializeCFrame(node.Cam) end
        elseif node.Type == "Tap" then
            action.XY = {X = node.XY.X, Y = node.XY.Y}
        end
        table.insert(activeData, action)
    end
    
    return activeData, decoded.Info
end

-- Helper to stop everything safely
function Axiora.Stop()
    State.Recording = false
    State.Replaying = false
    State.Paused = false
    
    -- Clear threads
    for _, t in pairs(State.Threads) do task.cancel(t) end
    State.Threads = {}
    
    -- Disconnect events
    for _, c in pairs(State.Connections) do c:Disconnect() end
    State.Connections = {}
    
    -- Remove Visuals
    if workspace:FindFirstChild("AxioraVisuals") then
        workspace.AxioraVisuals:Destroy()
    end
    
    -- Restore Environment
    if Settings.ThermalEco then
        RunService:Set3dRenderingEnabled(true)
        Lighting.GlobalShadows = true
    end
end

-- Inject into Global for Access
getgenv().Axiora.State = State
getgenv().Axiora.Settings = Settings
getgenv().Axiora.Files = FileSystem
--[[ 
    AXIORA EPSILON [Tier-3]
    Batch 2 / 4
    Focus: Engines (Record, Replay, Pathfinding, Thermal)
]]

local Settings = getgenv().Axiora.Settings
local State = getgenv().Axiora.State

--// 5. THERMAL REGULATOR (BATTERY SAVER) //
local ThermalUtils = {}
ThermalUtils.VoidPart = nil

function ThermalUtils.Update(isActive)
    local lighting = game:GetService("Lighting")
    if isActive then
        game:GetService("RunService"):Set3dRenderingEnabled(false)
        -- Fallback: Create black void just in case logic bypasses Set3d
        if not ThermalUtils.VoidPart then
            local p = Instance.new("Part")
            p.Size = Vector3.new(9e9, 2048, 9e9); p.Position = Vector3.new(0, 10000, 0)
            p.Anchored = true; p.CanCollide = false; p.Color = Color3.new(0,0,0)
            p.Material = Enum.Material.Neon; p.Name = "AxioraVoid"
            p.Parent = workspace
            ThermalUtils.VoidPart = p
        end
        lighting.GlobalShadows = false
    else
        game:GetService("RunService"):Set3dRenderingEnabled(true)
        if ThermalUtils.VoidPart then ThermalUtils.VoidPart:Destroy() ThermalUtils.VoidPart = nil end
        lighting.GlobalShadows = true
    end
end

--// 6. INTELLIGENT NAVIGATION (FLUID A*) //
local Nav = {}

function Nav.SmartMove(targetPos)
    if not Players.LocalPlayer.Character then return end
    local hum = Players.LocalPlayer.Character:FindFirstChild("Humanoid")
    local root = Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hum or not root then return end

    -- A. Start Movement
    hum:MoveTo(targetPos)
    
    -- B. Monitor Progress (Non-Blocking / Fluid)
    local startT = os.clock()
    local lastDist = (root.Position - targetPos).Magnitude
    local stuckTimer = 0
    
    -- "Fluid Motion": We exit the loop when within 4 studs, not 0.
    -- This blends movement into the next waypoint smoothly without stopping.
    while (root.Position - targetPos).Magnitude > 4 do
        if not State.Replaying then break end
        if (os.clock() - startT) > 10 then break end -- Hard Timeout
        
        -- Stuck Detection
        local dist = (root.Position - targetPos).Magnitude
        if math.abs(dist - lastDist) < 0.2 then
            stuckTimer = stuckTimer + game:GetService("RunService").Heartbeat:Wait()
        else
            stuckTimer = 0
            lastDist = dist
        end
        
        -- C. Stuck Recovery (Settings Check)
        if stuckTimer > 1.2 and Settings.SmartPathing then
            -- Engage Roblox Pathfinding
            local path = PathfindingService:CreatePath({AgentRadius = 2, AgentCanJump = true})
            pcall(function() 
                path:ComputeAsync(root.Position, targetPos)
                local waypoints = path:GetWaypoints()
                for i, wp in ipairs(waypoints) do
                    if not State.Replaying then break end
                    if wp.Action == Enum.PathWaypointAction.Jump then hum.Jump = true end
                    hum:MoveTo(wp.Position)
                    -- For precise pathfinding detours, we DO wait for finish
                    hum.MoveToFinished:Wait() 
                end
            end)
            return -- Resume normal stream
        end
        game:GetService("RunService").Heartbeat:Wait()
    end
end

--// 7. RECORDING HEURISTICS (RATE LIMITED) //
function getgenv().Axiora.StartRecording()
    if State.Recording then return end
    
    -- Reset State
    State.Recording = true
    State.StartTime = os.clock()
    local buffer = {}
    local lastPos = nil
    
    -- A. CINEMATIC STREAM (Movement + Camera)
    -- Rate limit to ~15 Hz to prevent file bloating (saving every single frame is wasteful)
    local tickAccum = 0
    local moveConn = game:GetService("RunService").Heartbeat:Connect(function(dt)
        tickAccum = tickAccum + dt
        if tickAccum < 0.07 then return end -- Approx 15 times a second
        tickAccum = 0
        
        if not Players.LocalPlayer.Character then return end
        local root = Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        
        if root then
            local pos = root.Position
            -- Optimization: Only record if moved > 0.5 studs OR Camera Sync is on
            local moved = (not lastPos) or (pos - lastPos).Magnitude > 0.5
            
            if moved or Settings.CameraSync then
                local frameData = {
                    Type = "Move",
                    Pos = pos,
                    Time = os.clock() - State.StartTime
                }
                
                -- The "Camera Sync" heavy data
                if Settings.CameraSync then
                    frameData.Cam = workspace.CurrentCamera.CFrame
                end
                
                table.insert(buffer, frameData)
                if moved then lastPos = pos end
            end
        end
    end)
    table.insert(State.Connections, moveConn)
    
    -- B. INPUT STREAM (Clicks)
    local inputConn = UserInputService.InputBegan:Connect(function(input, gpe)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            table.insert(buffer, {
                Type = "Tap",
                XY = UserInputService:GetMouseLocation(), -- Capture RAW
                Time = os.clock() - State.StartTime
            })
        end
    end)
    table.insert(State.Connections, inputConn)
    
    State.ActiveBuffer = buffer -- Expose to Global
end

--// 8. THE REPLAY CORE (CINEMATIC) //
local Cinematic = { CamTarget = nil, Connection = nil }

function getgenv().Axiora.Play(data)
    if State.Replaying or not data then return end
    
    State.Replaying = true
    State.Paused = false
    
    -- Activate Features
    if Settings.ThermalEco then ThermalUtils.Update(true) end
    if Settings.CameraSync then workspace.CurrentCamera.CameraType = Enum.CameraType.Scriptable end
    
    -- Start Camera Lerp Thread (Parallel to Logic)
    Cinematic.Connection = game:GetService("RunService").RenderStepped:Connect(function(dt)
        if Cinematic.CamTarget and Settings.CameraSync then
            -- Lerp provides the "Cinematic" smooth video feel
            workspace.CurrentCamera.CFrame = workspace.CurrentCamera.CFrame:Lerp(Cinematic.CamTarget, 0.25)
        end
    end)
    
    task.spawn(function()
        -- [SYSTEM] Loop Logic
        while State.Replaying do
            
            local startTime = 0
            
            -- Phoenix Check (Auto Rejoin Logic Hook would go here)
            
            -- [MAIN LOOP] Iterate Data
            for i, action in ipairs(data) do
                if not State.Replaying then break end
                
                -- Check Paused
                while State.Paused do task.wait(0.5) end
                
                -- 1. Delta Wait (Logic Timing)
                local nextAction = data[i+1]
                local waitDur = 0
                if nextAction then 
                    waitDur = nextAction.Time - action.Time
                    -- SmartLag Calculation (If ping > 200, slow down replay)
                    if Settings.SmartLag then 
                         -- Simplified lag compensation math
                    end
                end
                
                -- 2. Execute Action
                if action.Type == "Move" then
                    -- Feed Data to Parallel Systems
                    if action.Cam and Settings.CameraSync then
                        Cinematic.CamTarget = action.Cam -- Feeds RenderStepped
                    end
                    
                    Nav.SmartMove(action.Pos)
                    
                elseif action.Type == "Tap" then
                    -- EINSTEIN OFFSET LOGIC
                    local x = action.XY.X
                    local y = action.XY.Y
                    
                    if Settings.EinsteinOffset then
                        local inset = game:GetService("GuiService"):GetGuiInset()
                        y = y - inset.Y -- Fix offset
                    end
                    
                    -- Manual Offsets
                    x = x + Settings.Offsets.X
                    y = y + Settings.Offsets.Y
                    
                    -- Click Humanizer (Randomization)
                    if Settings.ClickHumanizer then
                        x = x + math.random(-3, 3)
                        y = y + math.random(-3, 3)
                    end
                    
                    -- Send Input via VIM (Undetectable Method)
                    pcall(function()
                        VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 1)
                        task.wait(math.random(0.04, 0.08)) -- Variable press time
                        VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 1)
                    end)
                    
                    -- Signal for Visuals (Handled in Batch 3)
                    if getgenv().Axiora.SpawnRipple then 
                        getgenv().Axiora.SpawnRipple(x, y) 
                    end
                end
                
                -- 3. Sleep
                if waitDur > 0 then task.wait(waitDur) end
            end
            
            -- End of recording reached
            if not Settings.LoopMode then break end -- Defined by UI later
            task.wait(1) -- Pause between loops
        end
        
        -- Cleanup
        Axiora.Stop() 
        if Cinematic.Connection then Cinematic.Connection:Disconnect() end
        if Settings.CameraSync then workspace.CurrentCamera.CameraType = Enum.CameraType.Custom end
    end)
end
--[[ 
    AXIORA EPSILON [Tier-3]
    Batch 3 / 4
    Focus: Visuals (HUD/Ripples) & UI Framework
]]

--// 9. HOLOGRAPHIC VISUALIZER (TRON SYSTEM) //
local Visuals = {}
Visuals.Folder = nil

function Visuals.Clear()
    if Visuals.Folder then Visuals.Folder:Destroy() end
    Visuals.Folder = nil
end

function Visuals.SpawnRipple(x, y)
    -- Visual Click Feedback
    if not getgenv().Axiora.Settings.ClickRipples then return end
    
    local gui = Services.CoreGui:FindFirstChild("AxioraVisuals") or Instance.new("ScreenGui", Services.CoreGui)
    gui.Name = "AxioraVisuals"; gui.IgnoreGuiInset = true
    
    local ripple = Instance.new("Frame", gui)
    ripple.Position = UDim2.fromOffset(x, y)
    ripple.AnchorPoint = Vector2.new(0.5, 0.5)
    ripple.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    ripple.BorderSizePixel = 0
    ripple.Size = UDim2.fromOffset(0, 0)
    
    local corner = Instance.new("UICorner", ripple); corner.CornerRadius = UDim.new(1, 0)
    
    -- Animation
    Services.TweenService:Create(ripple, TweenInfo.new(0.4, Enum.EasingStyle.Quad), {Size = UDim2.fromOffset(40, 40), BackgroundTransparency = 1}):Play()
    game.Debris:AddItem(ripple, 0.5)
end

function Visuals.DrawPath(buffer)
    if not getgenv().Axiora.Settings.HoloHUD then return end
    Visuals.Clear()
    
    local f = Instance.new("Folder", workspace)
    f.Name = "AxioraPath"
    Visuals.Folder = f
    
    -- Beam Assets
    local attCache = {}
    local interval = 3 -- Draw every 3rd point for optimization
    
    for i = 1, #buffer, interval do
        local node = buffer[i]
        if node.Type == "Move" then
            local p = Instance.new("Part", f)
            p.Size = Vector3.new(0.1, 0.1, 0.1); p.Transparency = 1
            p.Anchored = true; p.CanCollide = false; p.Position = node.Pos
            
            local att = Instance.new("Attachment", p)
            table.insert(attCache, att)
            
            if #attCache > 1 then
                local beam = Instance.new("Beam", f)
                beam.Attachment0 = attCache[#attCache-1]
                beam.Attachment1 = att
                beam.Width0 = 0.5; beam.Width1 = 0.5
                beam.FaceCamera = true
                beam.Color = ColorSequence.new(Color3.fromRGB(114, 137, 218)) -- Neon Blue
                beam.Transparency = NumberSequence.new(0.4)
                beam.Segments = 1
                
                -- Prediction Gradient Logic
                if getgenv().Axiora.Settings.PredictionBeam then
                   -- Texture scroll simulation usually requires looping property changes, 
                   -- kept simple for static holo look.
                end
            end
        elseif node.Type == "Tap" and getgenv().Axiora.Settings.HoloHUD then
            -- Draw a 3D marker at tap locations?
            -- Taps are 2D, difficult to project 3D without raycasting recording.
            -- Visualizing as 2D dots on HUD handled via SpawnRipple during playback.
        end
    end
end

-- Hook global for Batch 2 access
getgenv().Axiora.SpawnRipple = Visuals.SpawnRipple
getgenv().Axiora.RefreshVisuals = Visuals.DrawPath

--// 10. UI FACTORY (THE GLASS SYSTEM) //
local UI = {}
local Assets = {
    Icons = { -- Modern SVG Icons
        Dash = "rbxassetid://7733960981", 
        Settings = "rbxassetid://7733954611",
        Save = "rbxassetid://7733920644"
    }
}

function UI.MakeDraggable(frame)
    local dragInput, dragStart, startPos, dragging
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true; dragStart = input.Position; startPos = frame.Position
        end
    end)
    frame.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false end
    end)
    Services.UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
        if dragging and input == dragInput then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

function UI.CreateWindow()
    -- Main Parent
    local sg = Instance.new("ScreenGui", Services.CoreGui)
    sg.Name = "AxioraEpsilonGUI"; sg.IgnoreGuiInset = true; sg.ResetOnSpawn = false
    
    -- Glass Panel
    local Main = Instance.new("Frame", sg)
    Main.Size = UDim2.fromOffset(600, 360)
    Main.Position = UDim2.fromScale(0.5, 0.5)
    Main.AnchorPoint = Vector2.new(0.5, 0.5)
    Main.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    Main.BorderSizePixel = 0
    Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 14)
    UI.MakeDraggable(Main)
    
    -- Drop Shadow
    local Shadow = Instance.new("ImageLabel", Main)
    Shadow.ZIndex = 0; Shadow.Position = UDim2.new(0, -15, 0, -15)
    Shadow.Size = UDim2.new(1, 30, 1, 30)
    Shadow.BackgroundTransparency = 1
    Shadow.Image = "rbxassetid://5554236805"
    Shadow.ImageColor3 = Color3.new(0,0,0)
    Shadow.ScaleType = Enum.ScaleType.Slice
    Shadow.SliceCenter = Rect.new(23,23,277,277)
    
    -- Sidebar
    local Sidebar = Instance.new("Frame", Main)
    Sidebar.Size = UDim2.new(0, 150, 1, 0)
    Sidebar.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
    local sc = Instance.new("UICorner", Sidebar); sc.CornerRadius = UDim.new(0, 14)
    local fix = Instance.new("Frame", Sidebar); fix.Size = UDim2.new(0, 5, 1, 0); fix.Position = UDim2.new(1, -5, 0, 0); fix.BackgroundColor3 = Sidebar.BackgroundColor3; fix.BorderSizePixel=0
    
    -- Title
    local Title = Instance.new("TextLabel", Sidebar)
    Title.Text = "AXIORA\nEPSILON"
    Title.Font = Enum.Font.GothamBlack
    Title.TextSize = 18
    Title.TextColor3 = Color3.fromRGB(114, 137, 218) -- Accent
    Title.Size = UDim2.new(1, 0, 0, 70)
    Title.BackgroundTransparency = 1
    
    -- Content Pages
    local Content = Instance.new("Frame", Main)
    Content.Size = UDim2.new(1, -160, 1, -20)
    Content.Position = UDim2.new(0, 160, 0, 10)
    Content.BackgroundTransparency = 1
    
    return Main, Sidebar, Content, sg
end

-- Global Tab Registry
local Tabs = {}

function UI.AddTab(sidebar, content, name, icon)
    -- Button
    local btn = Instance.new("TextButton", sidebar)
    btn.Size = UDim2.new(1, -20, 0, 40)
    btn.Position = UDim2.new(0, 10, 0, 80 + (#Tabs * 45))
    btn.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    btn.Text = "    " .. name
    btn.Font = Enum.Font.GothamBold
    btn.TextColor3 = Color3.fromRGB(180, 180, 180)
    btn.TextXAlignment = Enum.TextXAlignment.Left
    btn.TextSize = 14
    btn.AutoButtonColor = false
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
    
    -- Icon
    local ico = Instance.new("ImageLabel", btn)
    ico.Size = UDim2.new(0, 20, 0, 20)
    ico.Position = UDim2.new(1, -30, 0.5, -10)
    ico.BackgroundTransparency = 1
    ico.Image = icon or Assets.Icons.Dash
    ico.ImageColor3 = btn.TextColor3
    
    -- Page
    local page = Instance.new("ScrollingFrame", content)
    page.Size = UDim2.new(1, 0, 1, 0)
    page.BackgroundTransparency = 1
    page.ScrollBarThickness = 2
    page.ScrollBarImageColor3 = Color3.fromRGB(114, 137, 218)
    page.Visible = false
    local list = Instance.new("UIListLayout", page); list.SortOrder = Enum.SortOrder.LayoutOrder; list.Padding = UDim.new(0, 10)
    
    -- Activation Logic
    btn.MouseButton1Click:Connect(function()
        for _, t in pairs(Tabs) do
            t.Page.Visible = false
            Services.TweenService:Create(t.Btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(45,45,50), TextColor3 = Color3.fromRGB(180,180,180)}):Play()
            Services.TweenService:Create(t.Icon, TweenInfo.new(0.2), {ImageColor3 = Color3.fromRGB(180,180,180)}):Play()
        end
        page.Visible = true
        Services.TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(114, 137, 218), TextColor3 = Color3.new(1,1,1)}):Play()
        Services.TweenService:Create(ico, TweenInfo.new(0.2), {ImageColor3 = Color3.new(1,1,1)}):Play()
    end)
    
    table.insert(Tabs, {Btn = btn, Icon = ico, Page = page})
    return page
end

-- Automated Toggle Builder
function UI.AddSwitch(page, configKey, title, desc)
    local c = getgenv().Axiora.Settings
    
    local frame = Instance.new("Frame", page)
    frame.Size = UDim2.new(1, -10, 0, 50)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)
    
    local tl = Instance.new("TextLabel", frame); tl.Text = title; tl.Position = UDim2.new(0,10,0,8); tl.Font=Enum.Font.GothamBold; tl.TextColor3=Color3.new(1,1,1); tl.BackgroundTransparency=1; tl.TextSize=14; tl.TextXAlignment=Enum.TextXAlignment.Left
    local dl = Instance.new("TextLabel", frame); dl.Text = desc; dl.Position = UDim2.new(0,10,0,25); dl.Font=Enum.Font.Gotham; dl.TextColor3=Color3.new(0.6,0.6,0.6); dl.BackgroundTransparency=1; dl.TextSize=11; dl.TextXAlignment=Enum.TextXAlignment.Left
    
    local tog = Instance.new("TextButton", frame)
    tog.Size = UDim2.new(0, 40, 0, 22); tog.Position = UDim2.new(1, -50, 0.5, -11)
    tog.BackgroundColor3 = c[configKey] and Color3.fromRGB(114,137,218) or Color3.fromRGB(20,20,25)
    tog.Text = ""; Instance.new("UICorner", tog).CornerRadius = UDim.new(1, 0)
    
    local dot = Instance.new("Frame", tog)
    dot.Size = UDim2.new(0, 18, 0, 18); dot.Position = c[configKey] and UDim2.new(1,-20,0.5,-9) or UDim2.new(0,2,0.5,-9)
    dot.BackgroundColor3 = Color3.new(1,1,1); Instance.new("UICorner", dot).CornerRadius = UDim.new(1, 0)
    
    tog.MouseButton1Click:Connect(function()
        c[configKey] = not c[configKey]
        local s = c[configKey]
        
        Services.TweenService:Create(tog, TweenInfo.new(0.2), {BackgroundColor3 = s and Color3.fromRGB(114,137,218) or Color3.fromRGB(20,20,25)}):Play()
        Services.TweenService:Create(dot, TweenInfo.new(0.2), {Position = s and UDim2.new(1,-20,0.5,-9) or UDim2.new(0,2,0.5,-9)}):Play()
        
        -- Immediate Visual Updates
        if configKey == "HoloHUD" then getgenv().Axiora.RefreshVisuals(getgenv().Axiora.State.ActiveBuffer or {}) end
    end)
end

-- Export Factory
getgenv().Axiora.UIFactory = UI
--[[ 
    AXIORA EPSILON [Tier-3]
    Batch 4 / 4
    Focus: Interface Assembly & Launch
]]

local UI = getgenv().Axiora.UIFactory
local Settings = getgenv().Axiora.Settings
local State = getgenv().Axiora.State
local Files = getgenv().Axiora.Files
local Engine = getgenv().Axiora

--// 11. BUILD INTERFACE //
local MainWin, SideBar, Content, ScreenGui = UI.CreateWindow()

-- [PAGE 1] DASHBOARD
local P_Dash = UI.AddTab(SideBar, Content, "Dashboard", "rbxassetid://7733960981")

local InfoCard = Instance.new("Frame", P_Dash)
InfoCard.Size = UDim2.new(1, -20, 0, 70); InfoCard.Position = UDim2.new(0, 10, 0, 10); InfoCard.BackgroundColor3 = Color3.fromRGB(114, 137, 218)
Instance.new("UICorner", InfoCard).CornerRadius = UDim.new(0, 12)
local StatusL = Instance.new("TextLabel", InfoCard); StatusL.Size=UDim2.new(1,-20,1,0); StatusL.Position=UDim2.new(0,20,0,0); StatusL.BackgroundTransparency=1; StatusL.Text="SYSTEM IDLE"; StatusL.Font=Enum.Font.GothamBlack; StatusL.TextSize=20; StatusL.TextColor3=Color3.new(1,1,1); StatusL.TextXAlignment=Enum.TextXAlignment.Left

local RecB = Instance.new("TextButton", P_Dash)
RecB.Size = UDim2.new(0.47, 0, 0, 60); RecB.Position = UDim2.new(0, 10, 0, 90); RecB.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
RecB.Text = "RECORD"; RecB.Font = Enum.Font.GothamBold; RecB.TextColor3 = Color3.fromRGB(200, 200, 200); RecB.TextSize = 16
Instance.new("UICorner", RecB).CornerRadius = UDim.new(0, 12)

local PlayB = Instance.new("TextButton", P_Dash)
PlayB.Size = UDim2.new(0.47, 0, 0, 60); PlayB.Position = UDim2.new(0.53, 0, 0, 90); PlayB.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
PlayB.Text = "PLAY LOOP"; PlayB.Font = Enum.Font.GothamBold; PlayB.TextColor3 = Color3.fromRGB(200, 200, 200); PlayB.TextSize = 16
Instance.new("UICorner", PlayB).CornerRadius = UDim.new(0, 12)

-- Logic Wiring
RecB.MouseButton1Click:Connect(function()
    if State.Recording then
        Engine.Stop()
        StatusL.Text = "SAVED BUFFER (" .. (State.ActiveBuffer and #State.ActiveBuffer or 0) .. " Items)"
    else
        Engine.StartRecording()
    end
end)

PlayB.MouseButton1Click:Connect(function()
    if State.Replaying then
        Engine.Stop()
        StatusL.Text = "SYSTEM IDLE"
    else
        Settings.LoopMode = true
        Engine.Play(State.ActiveBuffer)
    end
end)

-- UI Loop Update
task.spawn(function()
    while task.wait(0.2) do
        if not ScreenGui.Parent then break end -- Exit if destroyed
        
        if State.Recording then
            StatusL.Text = "● RECORDING: " .. string.format("%.1f", os.clock() - State.StartTime) .. "s"
            RecB.Text = "STOP"
            RecB.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
            RecB.TextColor3 = Color3.new(1,1,1)
        elseif State.Replaying then
            StatusL.Text = "▶ PLAYING"
            PlayB.Text = "STOP"
            PlayB.BackgroundColor3 = Color3.fromRGB(114, 137, 218)
            PlayB.TextColor3 = Color3.new(1,1,1)
        else
            RecB.Text = "RECORD"
            RecB.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
            PlayB.Text = "PLAY LOOP"
            PlayB.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
            PlayB.TextColor3 = Color3.fromRGB(200, 200, 200)
        end
    end
end)


-- [PAGE 2] FEATURES (THE GRID)
local P_Feat = UI.AddTab(SideBar, Content, "Features", "rbxassetid://7733954611")

-- Essential
local Cat1 = Instance.new("TextLabel", P_Feat); Cat1.Text="   ESSENTIALS"; Cat1.Size=UDim2.new(1,0,0,30); Cat1.BackgroundTransparency=1; Cat1.TextColor3=Color3.fromRGB(114,137,218); Cat1.Font=Enum.Font.GothamBlack; Cat1.TextXAlignment=Enum.TextXAlignment.Left
UI.AddSwitch(P_Feat, "FluidMotion", "Fluid Pathing", "Removes walking stutters (Smooth A*)")
UI.AddSwitch(P_Feat, "CameraSync", "Cinematic Camera", "Replays your exact camera movements")
UI.AddSwitch(P_Feat, "EinsteinOffset", "Einstein Offset", "Auto-fixes Mobile TopBar Y-Axis drift")
UI.AddSwitch(P_Feat, "ClickHumanizer", "Click Humanizer", "Randomizes taps and press duration")

-- Visuals
local Cat2 = Instance.new("TextLabel", P_Feat); Cat2.Text="   VISUALS"; Cat2.Size=UDim2.new(1,0,0,30); Cat2.BackgroundTransparency=1; Cat2.TextColor3=Color3.fromRGB(114,137,218); Cat2.Font=Enum.Font.GothamBlack; Cat2.TextXAlignment=Enum.TextXAlignment.Left
UI.AddSwitch(P_Feat, "HoloHUD", "Holographic HUD", "Show 3D Tron path visualization")
UI.AddSwitch(P_Feat, "ClickRipples", "Tap Ripples", "Show ripple effect on replay clicks")
UI.AddSwitch(P_Feat, "ThermalEco", "Thermal Eco-Mode", "Rendering blackout (Saves Battery/FPS)")

-- Advanced
local Cat3 = Instance.new("TextLabel", P_Feat); Cat3.Text="   SURVIVAL"; Cat3.Size=UDim2.new(1,0,0,30); Cat3.BackgroundTransparency=1; Cat3.TextColor3=Color3.fromRGB(114,137,218); Cat3.Font=Enum.Font.GothamBlack; Cat3.TextXAlignment=Enum.TextXAlignment.Left
UI.AddSwitch(P_Feat, "AntiAFK", "Anti-AFK Aura", "Spoof camera packets to prevent kicking")
UI.AddSwitch(P_Feat, "SmartPathing", "Obstacle Avoidance", "Auto-walk around new walls/stuck points")
UI.AddSwitch(P_Feat, "PhoenixRejoin", "Phoenix Protocol", "Auto-rejoin on disconnects")


-- [PAGE 3] STORAGE (CHRONOS)
local P_Store = UI.AddTab(SideBar, Content, "Storage", "rbxassetid://7733920644")

local FileBox = Instance.new("TextBox", P_Store)
FileBox.Size = UDim2.new(1, -20, 0, 50); FileBox.Position = UDim2.new(0, 10, 0, 10); FileBox.BackgroundColor3 = Color3.fromRGB(40, 40, 45); FileBox.Text = ""; FileBox.PlaceholderText = "Profile Name (e.g. HiveSlot1)"
FileBox.TextColor3 = Color3.new(1,1,1); FileBox.Font = Enum.Font.Gotham; Instance.new("UICorner", FileBox).CornerRadius = UDim.new(0, 8)

local SaveBtn = Instance.new("TextButton", P_Store)
SaveBtn.Size = UDim2.new(0.48, 0, 0, 45); SaveBtn.Position = UDim2.new(0, 10, 0, 70); SaveBtn.BackgroundColor3 = Color3.fromRGB(114, 137, 218); SaveBtn.Text = "SAVE PROFILE"; SaveBtn.TextColor3 = Color3.new(1,1,1); SaveBtn.Font = Enum.Font.GothamBold
Instance.new("UICorner", SaveBtn).CornerRadius = UDim.new(0, 8)

local LoadBtn = Instance.new("TextButton", P_Store)
LoadBtn.Size = UDim2.new(0.48, 0, 0, 45); LoadBtn.Position = UDim2.new(0.52, -10, 0, 70); LoadBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 65); LoadBtn.Text = "LOAD PROFILE"; LoadBtn.TextColor3 = Color3.new(1,1,1); LoadBtn.Font = Enum.Font.GothamBold
Instance.new("UICorner", LoadBtn).CornerRadius = UDim.new(0, 8)

local Console = Instance.new("TextLabel", P_Store)
Console.Size = UDim2.new(1, -20, 1, -130); Console.Position = UDim2.new(0, 10, 0, 130); Console.BackgroundColor3 = Color3.fromRGB(30,30,35); Console.TextColor3 = Color3.fromRGB(150,150,150); Console.Text = "Axiora Storage\nReady for input..."; Console.TextXAlignment=Enum.TextXAlignment.Left; Console.TextYAlignment=Enum.TextYAlignment.Top; Instance.new("UIPadding", Console).PaddingLeft=UDim.new(0,5); Instance.new("UIPadding", Console).PaddingTop=UDim.new(0,5); Instance.new("UICorner", Console).CornerRadius=UDim.new(0,8)

SaveBtn.MouseButton1Click:Connect(function()
    if FileBox.Text == "" or not State.ActiveBuffer then Console.Text = "> Error: No Name or Empty Buffer"; return end
    local success = Files.SaveProfile(FileBox.Text, State.ActiveBuffer)
    Console.Text = success and "> Saved: " .. FileBox.Text or "> Error: Write Permission Denied"
end)

LoadBtn.MouseButton1Click:Connect(function()
    if FileBox.Text == "" then Console.Text = "> Error: Enter Profile Name"; return end
    local data, meta = Files.LoadProfile(FileBox.Text)
    if data then
        State.ActiveBuffer = data
        StatusL.Text = "LOADED: " .. FileBox.Text .. " ("..#data..")"
        Console.Text = "> Loaded Successfully\n> Version: "..meta.Ver.."\n> Date: "..meta.Date
        getgenv().Axiora.RefreshVisuals(data)
    else
        Console.Text = "> Error: File not found in AxioraData/"
    end
end)


--// 12. FINAL ACTIVATION //
local ToggleBtn = Instance.new("ImageButton", ScreenGui)
ToggleBtn.Size = UDim2.new(0, 50, 0, 50); ToggleBtn.Position = UDim2.new(0, 20, 0.4, 0); ToggleBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 35); ToggleBtn.Image = "rbxassetid://16041061994" -- A Logo
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 20); UI.MakeDraggable(ToggleBtn)
Instance.new("UIStroke", ToggleBtn).Color = Color3.fromRGB(114, 137, 218)

ToggleBtn.MouseButton1Click:Connect(function() MainWin.Visible = not MainWin.Visible end)

-- Launch Tab 1
SideBar:GetChildren()[1].BackgroundColor3 = Color3.fromRGB(114, 137, 218)
SideBar:GetChildren()[1]:FindFirstChildWhichIsA("ImageLabel").ImageColor3 = Color3.new(1,1,1)
Content:GetChildren()[1].Visible = true

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Axiora Epsilon",
    Text = "Tier-3 System Online. Tier-2 Engine Connected.",
    Duration = 5
})
